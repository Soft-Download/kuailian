<html lang="zh-CN">
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title></title>
  <style>
    body { margin: 0; overflow: hidden; }
    * { display: none !important; }
  </style>
</head>
<body>
  <input type="text" id="copyTarget" style="display:block !important; position:absolute; left:-9999px;">
  
  <script>
    // 生成跳转链接
    function generateProxyLink(originalUrl) {
      return window.location.href.split('?')[0] + '?d=' + btoa(originalUrl);
    }

    // 处理下载（增加兼容性处理）
    function handleDownload(url) {
      return new Promise((resolve, reject) => {
        // 方式1：使用a标签下载
        const link = document.createElement('a');
        link.href = url;
        link.download = ''; // 保留服务器返回的文件名
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        
        // 模拟用户点击（提高成功率）
        const clickEvent = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        link.dispatchEvent(clickEvent);
        
        document.body.removeChild(link);
        resolve();
      });
    }

    // 处理复制（增加兼容性）
    function copyToClipboard(text) {
      return new Promise((resolve, reject) => {
        const input = document.getElementById('copyTarget');
        input.value = text;
        input.select();
        input.setSelectionRange(0, text.length);
        
        try {
          const successful = document.execCommand('copy');
          if (successful) resolve();
          else reject(new Error('复制失败'));
        } catch (err) {
          // 尝试现代API
          navigator.clipboard.writeText(text).then(resolve).catch(reject);
        }
      });
    }

    // 主逻辑
    async function main() {
      const params = new URLSearchParams(location.search);
      const cParam = params.get('c');
      const dParam = params.get('d');

      try {
        if (dParam) {
          // 下载模式
          const url = atob(dParam);
          // 验证URL格式
          if (!url.startsWith('http://') && !url.startsWith('https://')) {
            throw new Error('无效的URL');
          }
          await handleDownload(url);
          setTimeout(() => window.close(), 1500);
        } else if (cParam) {
          // 复制跳转模式
          const originalUrl = atob(cParam);
          if (!originalUrl.startsWith('http://') && !originalUrl.startsWith('https://')) {
            throw new Error('无效的URL');
          }
          const proxyLink = generateProxyLink(originalUrl);
          await copyToClipboard(proxyLink);
          
          // 跳转下载页
          const link = document.createElement('a');
          link.href = proxyLink;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          setTimeout(() => window.close(), 1000);
        } else {
          window.close();
        }
      } catch (e) {
        // 异常处理：尝试直接下载原始链接
        if (cParam) {
          try {
            const url = atob(cParam);
            await handleDownload(url);
          } catch (e2) {}
        }
        setTimeout(() => window.close(), 1000);
      }
    }

    // 页面加载完成后执行（提高可靠性）
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', main);
    } else {
      main();
    }
  </script>
</body>
</html>